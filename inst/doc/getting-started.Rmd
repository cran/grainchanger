---
title: "Using Grainchanger"
author: "Laura J. Graham"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using Grainchanger}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  comment = "#>"
)
```

```{r setup}
library(grainchanger)
library(ggplot2)
library(landscapetools)
```

## Data aggregation

The `grainchanger` package provides functionality for data aggregation to a grid via moving-window or direct methods. 

### Moving-window data aggregation

The moving-window data aggregation method smooths the surface using a specified function within a moving window of a specified size and shape prior to aggregation. 

The moving window approach allows users to capture some information about landscape structure at the scale at which the process acts in the landscape.

The below example shows the moving-window data aggregation in action. It aggregates a categorical raster to a grid using Shannon evenness as the function calculated within a square moving window of 5 units. This value is included as a column on the grid `sf` object. 

```{r mwda_example, fig.show='hold'}
g_sf$mwda <- winmove_agg(
  g = g_sf,
  dat = cat_ls, 
  d = 5,
  type = "rectangle",
  fun = "shei",
  lc_class = 0:3
)

show_landscape(cat_ls)

ggplot(g_sf) + geom_sf(aes(fill = mwda))
```

### Direct data aggregation 

The direct method simply aggregates to the grid using the specified function, essentially acting as a wrapper for the `raster` aggregate function. 

The below example shows the direct data aggregation in action. It aggregates a continuous raster to a grid using the range as the function calculated for each cell of the larger grid. This value is included as a column on the grid `sf` object. `var_range` is an inbuilt function in the `grainchanger` package.

```{r dda_example, fig.show='hold'}
g_sf$range <- nomove_agg(
  g = g_sf,
  dat = cat_ls, 
  fun = "var_range")

show_landscape(cont_ls)

ggplot(g_sf) + geom_sf(aes(fill = range))
```

## Functions

There are a number of inbuilt functions in the grainchanger package, with their useage outlined below. While it is possible to use user-defined functions within both `winmove_agg` and `nomove_agg`, we welcome suggestions for additional functions. Please [add as an issue](https://github.com/laurajanegraham/grainchanger/issues) - doing it this way means we can maximise the speed of the function. 

```{r functions, echo = FALSE}
function_overview <- data.frame(
  `Function Name` = c("wm_prop", "wm_classes", "wm_shei", "wm_mean", "nm_shei", "nm_prop", "var_range"),
  `Description` = c("Calculate the proportion of a given class within the moving window", 
                    "Calculate the number of classes within the moving window",
                    "Calculate the Shannon evenness within the moving window", 
                    "Calculate the mean value within the moving window", 
                    "Calculate the Shannon evenness within the larger cell",
                    "Calculate the proportion of a given class within the larger cell",
                    "Calculate the range of values (can be used with or without a moving window"),
  `Additional arguments` = c("lc_class (numeric)", 
                             "",
                             "lc_class (numeric)",
                             "", 
                             "lc_class (numeric)",
                             "lc_class (numeric)",
                             "")
)

knitr::kable(function_overview)
```

## Additional utilities

### Create torus

The `create_torus` function takes as input a square or rectangular landscape and pads it by a specified radius, creating the effect of a torus. We developed this function in order to avoid edge effects when testing methods on simulated landscapes (such as those from [NLMR](https://ropensci.github.io/NLMR/)). 

```{r torus}
torus <- create_torus(cat_ls, 5)

landscapetools::show_landscape(torus)
```